const t={};var e=Object.prototype.toString;function o(t){return t&&"object"==typeof t||!1}function r(e,o,r){var n,i=this;if(t.isFunction(e)&&(r=e,e=void 0),t.isFunction(o)&&(r=o,o=void 0),(o=o||{}).data=e,i.apiRoot.defaults.cache){o.url=t.constructUrl(i),n=i.apiRoot.cache.getKey(o);var a=i.apiRoot.cache.get(n);if(a)return r&&r(a.response,a.textStatus,a.jqXHR),t.clearIdentity(i),$.Deferred().resolve(a.response,a.textStatus,a.jqXHR)}var c=$.Deferred();return this._resourceRequest("GET",o).done(function(a,s,u){var l;e&&e.fields&&(l=t.select(e.fields)),i.storage&&!o.doNotStore&&(a=storage[i.collectionName].add(a,l,!0)),i.apiRoot.defaults.cache&&i.apiRoot.cache.put(n,{response:a,textStatus:s,jqXHR:u}),r&&r(a,s,u),c.resolve(a,s,u)}).fail(function(t,e,o){c.reject(t,e,o)}),t.clearIdentity(i),c}function n(e,o,r,n){var i,a=this,c=this.identity;t.isFunction(o)&&(n=o,o=void 0),t.isFunction(r)&&(n=r,r=void 0),r=r||{},a.storage&&o instanceof storage.Document?(i=o._id.toString(),o=o.$__delta()):a.storage&&storage.ObjectId.isValid(c)?i=c:a.storage&&o._id&&storage.ObjectId.isValid(o._id)&&(i=o._id.toString()),r.data=o;var s=$.Deferred();return this._resourceRequest(e,r).done(function(t,e,o){var c;a.storage&&!r.doNotStore&&((c=storage[a.collectionName].findById(i))?(c.set(t),storage[a.collectionName].updateIdLink(c),c.isNew=!1,t=c):t=storage[a.collectionName].add(t,void 0,!0)),n&&n(t,e,o),s.resolve(t,e,o)}).fail(function(t,e,o){s.reject(t,e,o)}),t.clearIdentity(a),s}function i(t){return function(){var e=Array.prototype.slice.call(arguments);return n.apply(this,[t].concat(e))}}function a(){this.data={}}t.isString=function(t){return"string"==typeof t||o(t)&&"[object String]"===e.call(t)||!1},t.isBoolean=function(t){return!0===t||!1===t||o(t)&&"[object Boolean]"===e.call(t)||!1},t.isObject=function(t){return t&&null!==t&&"object"===typeof t||!1},t.isFunction=function(t){return"function"==typeof t||!1},t.deepMerge=function t(e,o){var r=Array.isArray(o),n=r&&[]||{};if(r)e=e||[],n=n.concat(e),o.forEach(function(o,r){void 0===n[r]?n[r]=o:"object"==typeof o?n[r]=t(e[r],o):-1===e.indexOf(o)&&n.push(o)});else{if(e&&"object"==typeof e&&Object.keys(e).forEach(function(t){n[t]=e[t]}),null==o)return n;Object.keys(o).forEach(function(r){"object"==typeof o[r]&&o[r]&&e[r]?n[r]=t(e[r],o[r]):n[r]=o[r]})}return n},t.select=function(e){if(e){if(1!==arguments.length)throw new Error("Invalid select: select only takes 1 argument");var o={},r=typeof e;if("string"===r||"object"===r&&"number"==typeof e.length&&!Array.isArray(e)){"string"===r&&(e=e.split(/\s+/));for(var n=0,i=e.length;n<i;++n){var a=e[n];if(a){var c="-"===a[0]?0:1;0===c&&(a=a.substring(1)),o[a]=c}}return o}if(t.isObject(e)&&!Array.isArray(e)){for(var s=Object.keys(e),u=0;u<s.length;++u)o[s[u]]=e[s[u]];return o}throw new TypeError("Invalid select() argument. Must be string or object.")}},t.clearIdentity=function(t){for(;t.parentResource;)t.identity="",t=t.parentResource},t.constructUrl=function t(e){var o=e.identity?"/"+e.identity:"/";return e.parentResource?t(e.parentResource)+"/"+e.url+o:e.url},a.prototype.getKey=function(e){var o="",r=this;return Object.keys(e).forEach(function(n){var i=e[n];o+=n+"="+(t.isObject(i)?"{"+r.getKey(i)+"}":i)+"|"}),o},a.prototype.put=function(t,e){this.data[t]={created:new Date,data:e}},a.prototype.get=function(t){var e;if(e=this.data[t])return e.data.response.__cached=!0,e.data},a.prototype.clear=function(){this.data={}};var c={resourceName:"resource",url:"",add:function(t,e,o){if(o||(o=e||{},e=this),this[t])throw new TypeError("The resource named "+t+"already exists.");if((o.schemaName||o.collectionName||o.storage)&&(o.collectionName=o.collectionName||t),this[t]=new s(t,e,o),o.collectionName&&!storage[o.collectionName]){var r=storage.schemas[o.schemaName];if(!r)throw new TypeError("Resource::"+t+" You cannot use storage (create collection), without specifying the schema of the data.");storage.createCollection(o.collectionName,r,this[t])}return this[t]},_resourceRequest:function(e,o,r){var n=t.constructUrl(this),i=this.notifications;return this.apiRoot._request(e,n,o.data,o,i,r)}};function s(e,o,r){var n=function e(o){return null==o?e:(o&&!t.isString(o)&&console.error("identity должен быть строкой, а не",o),e.identity=o||"",e)};return $.extend(n,c,{resourceName:e,url:e},r),n.parentResource=o,n.apiRoot=o.apiRoot||o,n}function u(e,o){if(!(this instanceof u))return new u(e,o);this.defaults={stripTrailingSlashes:!0,cache:!0},t.isObject(e)&&(o=e,e=location.origin),null==e&&(e=location.origin),(o=o||{}).url=e,this.notifications=!1,this.hooks={data:{},headers:{}},$.extend(!0,this,o),this.defaults.cache&&(this.cache=new a)}c.get=r,c.read=r,c.post=i("POST"),c.create=c.post,c.put=i("PUT"),c.update=c.put,c.save=c.put,c.patch=i("PATCH"),c.delete=function(e,o,r){t.isFunction(e)&&(r=e,e=void 0),t.isFunction(o)&&(r=o,o=void 0),(o=o||{}).data=e;var n=$.Deferred();return this._resourceRequest("DELETE",o).done(function(t,e,o){r&&r(t,e,o),n.resolve(t,e,o)}).fail(function(t,e,o){n.reject(t,e,o)}),t.clearIdentity(this),n},u.prototype={add:c.add,_methods:{create:"POST",read:"GET",update:"PUT",delete:"DELETE",patch:"PATCH",post:"POST",get:"GET",save:"PUT"},_prepareAjaxSettings:function(e,o,r,n){var i=t.deepMerge(this.hooks,n);return i.type=e,this.defaults.stripTrailingSlashes&&(o=o.replace(/\/+$/,"")||"/"),i.url=o,this.token&&n.headers&&null==n.headers.token&&(i.headers.Authorization="token "+this.token),"GET"===e?i.data=t.deepMerge(i.data,r):(r&&r.constructor&&r.constructor.name&&"Document"===r.constructor.name?i.data=t.deepMerge(i.data,r.toObject({depopulate:1})):r&&(i.data=t.deepMerge(i.data,r)),i.data&&"application/json"===i.contentType&&(i.data=JSON.stringify(i.data))),t.isObject(o)&&(console.info("Ах@*ть, нужный код!!!!"),i=o),i},_request:function(e,o,r,n,i,a){if(!t.isString(e))throw new Error("Параметр `method` должен быть строкой, а не ",e);var c=this,s="GET"===e?"load":"POST"===e||"PUT"===e||"PATCH"===e?"save":"delete",u=this._prepareAjaxSettings(e,o,r,n);return(i=t.isBoolean(i)?i&&cf.notification:this.notifications&&cf.notification)&&cf.notification[s].show(),console.log(e+" "+u.url),$.ajax(u).fail(function(t,u,l){if(console.warn(t,u,l),401===t.status&&c.unauthorizedCallback)return c.unauthorizedCallback(t,e,o,r,n,a),void(i&&cf.notification[s].hide());i&&cf.notification[s].fail()}).done(function(){i&&cf.notification[s].hide()}).done(a)}},u.prototype.get=function(e,o){return console.log("api::get"),t.isFunction(e)&&(o=e,e=void 0),e=e||{},this._request("GET",this.url,void 0,e,!1,o)},u.prototype.read=u.prototype.get,u.version="0.3.0",u.utils=t;export{u as ApiClient};
