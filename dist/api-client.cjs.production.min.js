"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const utils={};var boolTag="[object Boolean]",stringTag="[object String]",objectProto=Object.prototype,objToString=objectProto.toString;function isObjectLike(e){return e&&"object"==typeof e||!1}function getRequest(e,t,i){var o,r=this;if(utils.isFunction(e)&&(i=e,e=void 0),utils.isFunction(t)&&(i=t,t=void 0),(t=t||{}).data=e,r.apiRoot.defaults.cache){t.url=utils.constructUrl(r),o=r.apiRoot.cache.getKey(t);var n=r.apiRoot.cache.get(o);if(n)return i&&i(n.response,n.textStatus,n.jqXHR),utils.clearIdentity(r),$.Deferred().resolve(n.response,n.textStatus,n.jqXHR)}var s=$.Deferred();return this._resourceRequest("GET",t).done(function(n,a,c){var u;e&&e.fields&&(u=utils.select(e.fields)),r.storage&&!t.doNotStore&&(n=storage[r.collectionName].add(n,u,!0)),r.apiRoot.defaults.cache&&r.apiRoot.cache.put(o,{response:n,textStatus:a,jqXHR:c}),i&&i(n,a,c),s.resolve(n,a,c)}).fail(function(e,t,i){s.reject(e,t,i)}),utils.clearIdentity(r),s}function postLikeRequest(e,t,i,o){var r,n=this,s=this.identity;utils.isFunction(t)&&(o=t,t=void 0),utils.isFunction(i)&&(o=i,i=void 0),i=i||{},n.storage&&t instanceof storage.Document?(r=t._id.toString(),t=t.$__delta()):n.storage&&storage.ObjectId.isValid(s)?r=s:n.storage&&t._id&&storage.ObjectId.isValid(t._id)&&(r=t._id.toString()),i.data=t;var a=$.Deferred();return this._resourceRequest(e,i).done(function(e,t,s){var c;n.storage&&!i.doNotStore&&((c=storage[n.collectionName].findById(r))?(c.set(e),storage[n.collectionName].updateIdLink(c),c.isNew=!1,e=c):e=storage[n.collectionName].add(e,void 0,!0)),o&&o(e,t,s),a.resolve(e,t,s)}).fail(function(e,t,i){a.reject(e,t,i)}),utils.clearIdentity(n),a}function createPostLikeRequest(e){return function(){var t=Array.prototype.slice.call(arguments);return postLikeRequest.apply(this,[e].concat(t))}}function deleteRequest(e,t,i){utils.isFunction(e)&&(i=e,e=void 0),utils.isFunction(t)&&(i=t,t=void 0),(t=t||{}).data=e;var o=$.Deferred();return this._resourceRequest("DELETE",t).done(function(e,t,r){i&&i(e,t,r),o.resolve(e,t,r)}).fail(function(e,t,i){o.reject(e,t,i)}),utils.clearIdentity(this),o}function Cache(){this.data={}}utils.isString=function(e){return"string"==typeof e||isObjectLike(e)&&objToString.call(e)===stringTag||!1},utils.isBoolean=function(e){return!0===e||!1===e||isObjectLike(e)&&objToString.call(e)===boolTag||!1},utils.isObject=function(e){return e&&null!==e&&"object"===typeof e||!1},utils.isFunction=function(e){return"function"==typeof e||!1},utils.deepMerge=function e(t,i){var o=Array.isArray(i),r=o&&[]||{};if(o)t=t||[],r=r.concat(t),i.forEach(function(i,o){void 0===r[o]?r[o]=i:"object"==typeof i?r[o]=e(t[o],i):-1===t.indexOf(i)&&r.push(i)});else{if(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){r[e]=t[e]}),null==i)return r;Object.keys(i).forEach(function(o){"object"==typeof i[o]&&i[o]&&t[o]?r[o]=e(t[o],i[o]):r[o]=i[o]})}return r},utils.select=function(e){if(e){if(1!==arguments.length)throw new Error("Invalid select: select only takes 1 argument");var t={},i=typeof e;if("string"===i||"object"===i&&"number"==typeof e.length&&!Array.isArray(e)){"string"===i&&(e=e.split(/\s+/));for(var o=0,r=e.length;o<r;++o){var n=e[o];if(n){var s="-"===n[0]?0:1;0===s&&(n=n.substring(1)),t[n]=s}}return t}if(utils.isObject(e)&&!Array.isArray(e)){for(var a=Object.keys(e),c=0;c<a.length;++c)t[a[c]]=e[a[c]];return t}throw new TypeError("Invalid select() argument. Must be string or object.")}},utils.clearIdentity=function(e){for(;e.parentResource;)e.identity="",e=e.parentResource},utils.constructUrl=function e(t){var i=t.identity?"/"+t.identity:"/";return t.parentResource?e(t.parentResource)+"/"+t.url+i:t.url},Cache.prototype.getKey=function(e){var t="",i=this;return Object.keys(e).forEach(function(o){var r=e[o];t+=o+"="+(utils.isObject(r)?"{"+i.getKey(r)+"}":r)+"|"}),t},Cache.prototype.put=function(e,t){this.data[e]={created:new Date,data:t}},Cache.prototype.get=function(e){var t;if(t=this.data[e])return t.data.response.__cached=!0,t.data},Cache.prototype.clear=function(){this.data={}};var resourceMixin={resourceName:"resource",url:"",add:function(e,t,i){if(i||(i=t||{},t=this),this[e])throw new TypeError("The resource named "+e+"already exists.");if((i.schemaName||i.collectionName||i.storage)&&(i.collectionName=i.collectionName||e),this[e]=new Resource(e,t,i),i.collectionName&&!storage[i.collectionName]){var o=storage.schemas[i.schemaName];if(!o)throw new TypeError("Resource::"+e+" You cannot use storage (create collection), without specifying the schema of the data.");storage.createCollection(i.collectionName,o,this[e])}return this[e]},_resourceRequest:function(e,t,i){var o=utils.constructUrl(this),r=this.notifications;return this.apiRoot._request(e,o,t.data,t,r,i)}};function Resource(e,t,i){var o=function e(t){return null==t?e:(t&&!utils.isString(t)&&console.error("identity должен быть строкой, а не",t),e.identity=t||"",e)};return $.extend(o,resourceMixin,{resourceName:e,url:e},i),o.parentResource=t,o.apiRoot=t.apiRoot||t,o}function ApiClient(e,t){if(!(this instanceof ApiClient))return new ApiClient(e,t);this.defaults={stripTrailingSlashes:!0,cache:!0},utils.isObject(e)&&(t=e,e=location.origin),null==e&&(e=location.origin),(t=t||{}).url=e,this.notifications=!1,this.hooks={data:{},headers:{}},$.extend(!0,this,t),this.defaults.cache&&(this.cache=new Cache)}resourceMixin.get=getRequest,resourceMixin.read=getRequest,resourceMixin.post=createPostLikeRequest("POST"),resourceMixin.create=resourceMixin.post,resourceMixin.put=createPostLikeRequest("PUT"),resourceMixin.update=resourceMixin.put,resourceMixin.save=resourceMixin.put,resourceMixin.patch=createPostLikeRequest("PATCH"),resourceMixin.delete=deleteRequest,ApiClient.prototype={add:resourceMixin.add,_methods:{create:"POST",read:"GET",update:"PUT",delete:"DELETE",patch:"PATCH",post:"POST",get:"GET",save:"PUT"},_prepareAjaxSettings:function(e,t,i,o){var r=utils.deepMerge(this.hooks,o);return r.type=e,this.defaults.stripTrailingSlashes&&(t=t.replace(/\/+$/,"")||"/"),r.url=t,this.token&&o.headers&&null==o.headers.token&&(r.headers.Authorization="token "+this.token),"GET"===e?r.data=utils.deepMerge(r.data,i):(i&&i.constructor&&i.constructor.name&&"Document"===i.constructor.name?r.data=utils.deepMerge(r.data,i.toObject({depopulate:1})):i&&(r.data=utils.deepMerge(r.data,i)),r.data&&"application/json"===r.contentType&&(r.data=JSON.stringify(r.data))),utils.isObject(t)&&(console.info("Ах@*ть, нужный код!!!!"),r=t),r},_request:function(e,t,i,o,r,n){if(!utils.isString(e))throw new Error("Параметр `method` должен быть строкой, а не ",e);var s=this,a="GET"===e?"load":"POST"===e||"PUT"===e||"PATCH"===e?"save":"delete",c=this._prepareAjaxSettings(e,t,i,o);return(r=utils.isBoolean(r)?r&&cf.notification:this.notifications&&cf.notification)&&cf.notification[a].show(),console.log(e+" "+c.url),$.ajax(c).fail(function(c,u,l){if(console.warn(c,u,l),401===c.status&&s.unauthorizedCallback)return s.unauthorizedCallback(c,e,t,i,o,n),void(r&&cf.notification[a].hide());r&&cf.notification[a].fail()}).done(function(){r&&cf.notification[a].hide()}).done(n)}},ApiClient.prototype.get=function(e,t){return console.log("api::get"),utils.isFunction(e)&&(t=e,e=void 0),e=e||{},this._request("GET",this.url,void 0,e,!1,t)},ApiClient.prototype.read=ApiClient.prototype.get,ApiClient.version="0.3.0",ApiClient.utils=utils,exports.ApiClient=ApiClient;
