!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).ApiClient={})}(this,function(t){"use strict";const e={};var o=Object.prototype.toString;function r(t){return t&&"object"==typeof t||!1}function n(t,o,r){var n,i=this;if(e.isFunction(t)&&(r=t,t=void 0),e.isFunction(o)&&(r=o,o=void 0),(o=o||{}).data=t,i.apiRoot.defaults.cache){o.url=e.constructUrl(i),n=i.apiRoot.cache.getKey(o);var a=i.apiRoot.cache.get(n);if(a)return r&&r(a.response,a.textStatus,a.jqXHR),e.clearIdentity(i),$.Deferred().resolve(a.response,a.textStatus,a.jqXHR)}var c=$.Deferred();return this._resourceRequest("GET",o).done(function(a,s,u){var d;t&&t.fields&&(d=e.select(t.fields)),i.storage&&!o.doNotStore&&(a=storage[i.collectionName].add(a,d,!0)),i.apiRoot.defaults.cache&&i.apiRoot.cache.put(n,{response:a,textStatus:s,jqXHR:u}),r&&r(a,s,u),c.resolve(a,s,u)}).fail(function(t,e,o){c.reject(t,e,o)}),e.clearIdentity(i),c}function i(t,o,r,n){var i,a=this,c=this.identity;e.isFunction(o)&&(n=o,o=void 0),e.isFunction(r)&&(n=r,r=void 0),r=r||{},a.storage&&o instanceof storage.Document?(i=o._id.toString(),o=o.$__delta()):a.storage&&storage.ObjectId.isValid(c)?i=c:a.storage&&o._id&&storage.ObjectId.isValid(o._id)&&(i=o._id.toString()),r.data=o;var s=$.Deferred();return this._resourceRequest(t,r).done(function(t,e,o){var c;a.storage&&!r.doNotStore&&((c=storage[a.collectionName].findById(i))?(c.set(t),storage[a.collectionName].updateIdLink(c),c.isNew=!1,t=c):t=storage[a.collectionName].add(t,void 0,!0)),n&&n(t,e,o),s.resolve(t,e,o)}).fail(function(t,e,o){s.reject(t,e,o)}),e.clearIdentity(a),s}function a(t){return function(){var e=Array.prototype.slice.call(arguments);return i.apply(this,[t].concat(e))}}function c(){this.data={}}e.isString=function(t){return"string"==typeof t||r(t)&&"[object String]"===o.call(t)||!1},e.isBoolean=function(t){return!0===t||!1===t||r(t)&&"[object Boolean]"===o.call(t)||!1},e.isObject=function(t){return t&&null!==t&&"object"===typeof t||!1},e.isFunction=function(t){return"function"==typeof t||!1},e.deepMerge=function t(e,o){var r=Array.isArray(o),n=r&&[]||{};if(r)e=e||[],n=n.concat(e),o.forEach(function(o,r){void 0===n[r]?n[r]=o:"object"==typeof o?n[r]=t(e[r],o):-1===e.indexOf(o)&&n.push(o)});else{if(e&&"object"==typeof e&&Object.keys(e).forEach(function(t){n[t]=e[t]}),null==o)return n;Object.keys(o).forEach(function(r){"object"==typeof o[r]&&o[r]&&e[r]?n[r]=t(e[r],o[r]):n[r]=o[r]})}return n},e.select=function(t){if(t){if(1!==arguments.length)throw new Error("Invalid select: select only takes 1 argument");var o={},r=typeof t;if("string"===r||"object"===r&&"number"==typeof t.length&&!Array.isArray(t)){"string"===r&&(t=t.split(/\s+/));for(var n=0,i=t.length;n<i;++n){var a=t[n];if(a){var c="-"===a[0]?0:1;0===c&&(a=a.substring(1)),o[a]=c}}return o}if(e.isObject(t)&&!Array.isArray(t)){for(var s=Object.keys(t),u=0;u<s.length;++u)o[s[u]]=t[s[u]];return o}throw new TypeError("Invalid select() argument. Must be string or object.")}},e.clearIdentity=function(t){for(;t.parentResource;)t.identity="",t=t.parentResource},e.constructUrl=function t(e){var o=e.identity?"/"+e.identity:"/";return e.parentResource?t(e.parentResource)+"/"+e.url+o:e.url},c.prototype.getKey=function(t){var o="",r=this;return Object.keys(t).forEach(function(n){var i=t[n];o+=n+"="+(e.isObject(i)?"{"+r.getKey(i)+"}":i)+"|"}),o},c.prototype.put=function(t,e){this.data[t]={created:new Date,data:e}},c.prototype.get=function(t){var e;if(e=this.data[t])return e.data.response.__cached=!0,e.data},c.prototype.clear=function(){this.data={}};var s={resourceName:"resource",url:"",add:function(t,e,o){if(o||(o=e||{},e=this),this[t])throw new TypeError("The resource named "+t+"already exists.");if((o.schemaName||o.collectionName||o.storage)&&(o.collectionName=o.collectionName||t),this[t]=new u(t,e,o),o.collectionName&&!storage[o.collectionName]){var r=storage.schemas[o.schemaName];if(!r)throw new TypeError("Resource::"+t+" You cannot use storage (create collection), without specifying the schema of the data.");storage.createCollection(o.collectionName,r,this[t])}return this[t]},_resourceRequest:function(t,o,r){var n=e.constructUrl(this),i=this.notifications;return this.apiRoot._request(t,n,o.data,o,i,r)}};function u(t,o,r){var n=function t(o){return null==o?t:(o&&!e.isString(o)&&console.error("identity должен быть строкой, а не",o),t.identity=o||"",t)};return $.extend(n,s,{resourceName:t,url:t},r),n.parentResource=o,n.apiRoot=o.apiRoot||o,n}function d(t,o){if(!(this instanceof d))return new d(t,o);this.defaults={stripTrailingSlashes:!0,cache:!0},e.isObject(t)&&(o=t,t=location.origin),null==t&&(t=location.origin),(o=o||{}).url=t,this.notifications=!1,this.hooks={data:{},headers:{}},$.extend(!0,this,o),this.defaults.cache&&(this.cache=new c)}s.get=n,s.read=n,s.post=a("POST"),s.create=s.post,s.put=a("PUT"),s.update=s.put,s.save=s.put,s.patch=a("PATCH"),s.delete=function(t,o,r){e.isFunction(t)&&(r=t,t=void 0),e.isFunction(o)&&(r=o,o=void 0),(o=o||{}).data=t;var n=$.Deferred();return this._resourceRequest("DELETE",o).done(function(t,e,o){r&&r(t,e,o),n.resolve(t,e,o)}).fail(function(t,e,o){n.reject(t,e,o)}),e.clearIdentity(this),n},d.prototype={add:s.add,_methods:{create:"POST",read:"GET",update:"PUT",delete:"DELETE",patch:"PATCH",post:"POST",get:"GET",save:"PUT"},_prepareAjaxSettings:function(t,o,r,n){var i=e.deepMerge(this.hooks,n);return i.type=t,this.defaults.stripTrailingSlashes&&(o=o.replace(/\/+$/,"")||"/"),i.url=o,this.token&&n.headers&&null==n.headers.token&&(i.headers.Authorization="token "+this.token),"GET"===t?i.data=e.deepMerge(i.data,r):(r&&r.constructor&&r.constructor.name&&"Document"===r.constructor.name?i.data=e.deepMerge(i.data,r.toObject({depopulate:1})):r&&(i.data=e.deepMerge(i.data,r)),i.data&&"application/json"===i.contentType&&(i.data=JSON.stringify(i.data))),e.isObject(o)&&(console.info("Ах@*ть, нужный код!!!!"),i=o),i},_request:function(t,o,r,n,i,a){if(!e.isString(t))throw new Error("Параметр `method` должен быть строкой, а не ",t);var c=this,s="GET"===t?"load":"POST"===t||"PUT"===t||"PATCH"===t?"save":"delete",u=this._prepareAjaxSettings(t,o,r,n);return(i=e.isBoolean(i)?i&&cf.notification:this.notifications&&cf.notification)&&cf.notification[s].show(),console.log(t+" "+u.url),$.ajax(u).fail(function(e,u,d){if(console.warn(e,u,d),401===e.status&&c.unauthorizedCallback)return c.unauthorizedCallback(e,t,o,r,n,a),void(i&&cf.notification[s].hide());i&&cf.notification[s].fail()}).done(function(){i&&cf.notification[s].hide()}).done(a)}},d.prototype.get=function(t,o){return console.log("api::get"),e.isFunction(t)&&(o=t,t=void 0),t=t||{},this._request("GET",this.url,void 0,t,!1,o)},d.prototype.read=d.prototype.get,d.version="0.3.0",d.utils=e,t.ApiClient=d,Object.defineProperty(t,"__esModule",{value:!0})});
